# Adsl derivations Derived = 1 level {#Variable}

List of Variables Derived = 1

| **Variable** | **Label**                          | **Source/Derivation/Comments**                                                            | R Dplyr Snippet                                                                                                                                                                                                    |
|--------------|------------------------------------|-------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| STUDYID      | Study Identifier                   | DM.STUDYID                                                                                | `select ( dm , studyid)`                                                                                                                                                                                           |
| USUBJID      | Unique Subject Identifier          | DM.USUBJID                                                                                | `select ( dm , usubjid)`                                                                                                                                                                                           |
| SUBJID       | Subject Identifier for the Study   | DM.SUBJID                                                                                 | `select ( dm , subjid)`                                                                                                                                                                                            |
| SITEID       | Study Site Identifier              | DM.SITEID                                                                                 | `select ( dm , siteid)`                                                                                                                                                                                            |
| ARM          | Description of Planned Arm         | DM.ARM                                                                                    | `select ( dm , arm)`                                                                                                                                                                                               |
| TRT01P       | Planned Treatment for Period 01    | DM.ARM                                                                                    | `select ( dm , arm)`                                                                                                                                                                                               |
| TRT01A       | Actual Treatment for Period 01     | TRT01A=TRT01P, i.e., no difference between actual and randomized treatment in this study. | `mutate ( dm , TRT01A= ARM)`                                                                                                                                                                                       |
| TRT01AN      | Actual Treatment for Period 01 (N) | Numeric code for TRT01A which corresponds to the randomized dose                          | `mutate( trt01pn  =ifelse( (arm %in% "Placebo" ) , 0 , ifelse( (arm %in% Xanomeline Low Dose" ) , 54, ifelse( (arm %in% "Xanomeline High Dose" ) , 81 , NA)))`                                                     |
| AGE          | Age                                | DM.AGE                                                                                    | `select ( dm , age)`                                                                                                                                                                                               |
| RACE         | Race                               | DM.RACE                                                                                   | `select ( dm , race)`                                                                                                                                                                                              |
| RACEN        | Race (N)                           | Numeric code for RACE                                                                     | `case_when( race %in% "WHITE" ~ 1 , race %in% "BLACK OR AFRICAN AMERICAN" ~ 2 ,                           race %in% "AMERICAN INDIAN OR ALASKA NATIVE" ~ 6 ,                              race %in% "ASIAN" ~ 7 )` |
| SEX          | Sex                                | DM.SEX                                                                                    | `select(dm,sex)`                                                                                                                                                                                                   |
| ETHNIC       | Ethnicity                          | DM.ETHNIC                                                                                 | `select(dm,ethnic)`                                                                                                                                                                                                |
| DTHFL        | Subject Died?                      | DM.DTHFL                                                                                  | `select(dm,dthfl)`                                                                                                                                                                                                 |
| RFSTDTC      | Subject Reference Start Date/Time  | DM.RFSTDTC                                                                                | `select(dm,rfstdtc)`                                                                                                                                                                                               |
| RFENDTC      | Subject Reference End Date/Time    | DM.RFENDTC                                                                                | `select(dm,rfendtc)`                                                                                                                                                                                               |
|              |                                    |                                                                                           |                                                                                                                                                                                                                    |
|              |                                    |                                                                                           |                                                                                                                                                                                                                    |
|              |                                    |                                                                                           |                                                                                                                                                                                                                    |
|              |                                    |                                                                                           |                                                                                                                                                                                                                    |
|              |                                    |                                                                                           |                                                                                                                                                                                                                    |
|              |                                    |                                                                                           |                                                                                                                                                                                                                    |
|              |                                    |                                                                                           |                                                                                                                                                                                                                    |
|              |                                    |                                                                                           |                                                                                                                                                                                                                    |

## Overview

#### Important Functions {.history}

dplyr is a grammar of data manipulation, providing a consistent set of verbs that help you solve the most common data manipulation challenges:

-   [`mutate()`](https://dplyr.tidyverse.org/reference/mutate.html) adds new variables that are functions of existing variables

-   [`select()`](https://dplyr.tidyverse.org/reference/select.html) picks variables based on their names.

-   [`filter()`](https://dplyr.tidyverse.org/reference/filter.html) picks cases based on their values.

-   [`summarise()`](https://dplyr.tidyverse.org/reference/summarise.html) reduces multiple values down to a single summary.

-   [`arrange()`](https://dplyr.tidyverse.org/reference/arrange.html) changes the ordering of the rows.

## Your Turn {.exercise}

\*\*List out various Character and Numeric Dplyr functions\*\*

[[Learn to use R Dplyr Package]](https://dplyr.tidyverse.org/)

1.  List out all the functions used

    [Filter](https://dplyr.tidyverse.org/reference/filter_all.html?q=filter "Filter within a selection of variables")

    [Select](https://dplyr.tidyverse.org/reference/select.html "Used to select the variables needed")

    [case_when](https://dplyr.tidyverse.org/reference/case_when.html?q=case%20_%20when "R equivalent of the SQL CASE WHEN statement. If no cases match, NA is returned")

    [if_else()](https://dplyr.tidyverse.org/reference/if_else.html?q=if%20_%20else "Compared to the base ifelse(), this function is more strict. It checks that true and false are the same type")

    as.character

    mutate

    inner_join

    as.Date(as.character(svstdtc) )

    as.Date

    [as.Date.numeric](https://www.rdocumentation.org/packages/zoo/versions/1.5-7/topics/as.Date.numeric "Date Conversion Functions From Numeric, Integer And Ts Objects Functions to convert numeric and related classes to objects of class "Date" representing calendar dates.")

    ## Let's start programming

    1.  Initialize all the Library's needed for the project

```{r}
#intilizing the Dplyr library
library(tidyverse)
library(clinicalfd)
```

2.  Bring in the datasets needed

```{r}
# dm <- clinicalfd::dm 
# names(clinicalfd::dm )
dm <- clinicalfd::dm
dm  <- dplyr :: filter(dm ,arm !="Screen Failure" )
adsl_deri01 <- dplyr::select ( dm , usubjid , siteid,arm) # Select 

#dm_01 <- mutate (dm_01 , usubjid = as.character(usubjid) )


adsl_deri01 <- dplyr::mutate( adsl_deri01 , TRT01P = arm) 
#Use of Mutate function to create new variable#
 
```

## Adsl Derivation Code part-1

```{r}
adsl_deri01 <- dm  %>% 
  filter (actarmcd !="Scrnfail")  %>% 
  mutate(sitegr1 = siteid , trt01p = arm , trt01a = arm , 
         usubjid = as.character(usubjid),
         trt01pn  = ifelse( (arm %in% "Placebo" ) , 0 ,
           ifelse( (arm %in% "Xanomeline Low Dose" ) , 54,
           ifelse( (arm %in% "Xanomeline High Dose" ) , 81 , NA))) ,
           trt01an = trt01pn ,
           ittfl   = ifelse (trt01pn %in% c(0,54,81) , "Y" , "N" ),
           agegr1  = case_when( age < 65  ~ "<65" , 
                              (65 <= age & age <= 80 ) ~ "65-80"  , 
                               (age > 80 ) ~ ">80"  ),

           
            agegr1n  = case_when( age < 65  ~ 1  , 
                                (65 <= age & age <= 80 ) ~ 2  , 
                                (age > 80 ) ~ 3  ),

           race  = case_when( race %in% "WHITE" ~ "WHITE" , 
                              race %in% "BLACK OR AFRICAN AMERICAN" ~                                "BLACK OR AFRICAN AMERICAN" ,
                              
            race %in% "AMERICAN INDIAN OR ALASKA NATIVE" ~ "AMERICAN INDIAN OR ALASKA NATIVE" ,
            race %in% "ASIAN" ~ "ASIAN" ) , 
            racen  = case_when( race %in% "WHITE" ~ 1 , 
            race %in% "BLACK OR AFRICAN AMERICAN" ~ 2 ,
            race %in% "AMERICAN INDIAN OR ALASKA NATIVE" ~ 6 ,
            race %in% "ASIAN" ~ 7 ),
            sex  =  case_when(sex %in% "F" ~ "Female"  , 
                             sex %in% "M" ~ "Male"    , 
                             sex %in% "U" ~  "Unknown" ) , 
           ethnic  =  case_when(ethnic %in% "NOT HISPANIC OR LATINO" ~ "NOT HISPANIC OR LATINO"  , 
           ethnic %in% "HISPANIC OR LATINO" ~ "HISPANIC OR LATINO"  , 
           ethnic %in% "U" ~  "Unknown" )
)




```

<div>

**Date of First Exposure to Treatment** `SV.SVSTDTC when SV.VISITNUM=3, converted to SAS date`

</div>

### **Date of First Exposure to Treatment (TRTSDT)**

```{r}
sv_visit3 <- clinicalfd::sv   
sv_visit3 <- sv_visit3 %>% 
             filter(visitnum == 3) %>% 
             mutate(usubjid = as.character(usubjid) , 
                    trtsdt = as.Date(as.character(svstdtc))  
                   ) %>% 
             select (usubjid , svstdtc , trtsdt )

sv_visit3
# nature of usubjid is character and svstdtc is <s3.labelled> 

adsl_deri01 <- inner_join(adsl_deri01, sv_visit3 , by = "usubjid")


adsl_deri02 <- adsl_deri01 %>%  
               
               select (usubjid , trtsdt, svstdtc , actarmcd , sitegr1, siteid , trt01p, arm , trt01a , trt01pn ,trt01pn,ittfl,agegr1,age,agegr1n,race               ,racen,sex,ethnic , rfstdtc ,
               rfendtc , sex , ethnic , dthfl )
#adsl_deri02

```

### Date of Last Exposure to Treatment (TRTEDT)

The date of final dose (from the CRF) is EX.EXENDTC on the subject's last EX record. If the date of final dose is missing for the subject and the subject discontinued after visit 3, use the date of discontinuation as the date of last dose.

Steps to arrive at logic

1.  Check for the subjects whose final dose date is missing
2.  `Check if these subjects discontinued after visit 3 (Check  if they have any records after the Visit 3 , this needs checked )`
3.  If they have not discontinued then use the SV date as date of last dose
4.  To find last.date use **slice_tail , slice_max within by group** or use **Dplyr::first or last functions** , compare it original dataset

```{r}
#Final dates check 

exendtc <- ex %>% 
            mutate(usubjid = as.character(usubjid) ,  
                   exendtc_orig = exendtc, 
                   exendtc = as.Date(as.character(exendtc)) ) %>% 
           select( usubjid ,visit , visitnum,  exendtc , exendtc_orig )

ds_disp <- ds %>% 
             filter (   dscat == "DISPOSITION EVENT" ) %>%
             mutate (usubjid = as.character(usubjid))   %>% 
           select ( usubjid , dsstdtc)

exendtc <- inner_join(exendtc , ds_disp  , by = "usubjid")



 
adsl_chk <- select (adsl , usubjid , trtedt )

```

`Using the as.Date(as.Character ()) is creating numerical dates and date formats are not being , need to learn more about the as.Date .`{=beamer}

using the as.Date( as.character () ) is creating numerical dates and date formats are not

Below Logic is how you conditionally create a new column trtedt based DSSTDTC and exendtc_orig

```{r}
# Subjects whose does dates are missing 
exendtc_1 <- exendtc %>% 
           mutate ( flag = ifelse (exendtc   %in% NA  ,  "N" ,"Y"   ) ,
           trtedt =   ifelse(flag == "N", as.character(dsstdtc), 
                        ifelse (flag =="Y" ,as.character(exendtc_orig)  , NA  ))  ) %>% 
           filter (visitnum >= 3 )


```

```{r}
#Final dates check 

exendtc <- ex %>% 
            mutate(usubjid = as.character(usubjid) ,  
                   exendtc_orig = exendtc, 
                   exendtc = as.Date(as.character(exendtc)) ) %>% 
           select( usubjid ,visit , visitnum,  exendtc , exendtc_orig )


exendtc <- inner_join(exendtc , sv_visit3 , by = "usubjid")

# Subjects whose does dates are missing 
exendtc <- exendtc %>% 
  
           mutate ( flag = ifelse (exendtc   %in% NA  ,  "N" ,"Y"   ), 
                    
           trtedt_c  = ifelse(exendtc   %in%  NA  , svstdtc , exendtc_orig ) , 
           trtedt   =  as.Date(as.character(trtedt_c))   ,
           
trtedt_n     = as.numeric(ifelse(exendtc   %in%  NA  ,trtsdt , exendtc ) ) 
#, trtedt_ndt   =  as.Date.numeric (trtedt_n)   
           
           )   %>% 
           filter (visitnum >= 3 )
 
# One of the ways to get the First and Last group by values 
# Make sure you use the right variables used group_by 

exend <- exendtc %>% 
         group_by (usubjid) %>% 
         dplyr:: mutate(
           first = dplyr::first(exendtc) , 
           last  = dplyr::last (exendtc)
         ) %>% 
          summarise(trtedt = last(exendtc))

#exendtc <- select(exendtc,usubjid ,visitnum , trtedt, trtedt_c  )


```
